importBtn.addEventListener('click', async () => {
    const file = fileInput.files[0];
    if (!file) {
        log('Error: Silakan pilih file GeoJSON terlebih dahulu.');
        return;
    }

    importBtn.disabled = true;
    importBtn.textContent = 'Memproses...';
    log('Memulai proses impor...');

    const reader = new FileReader();
    reader.onload = async (event) => {
        try {
            const geojsonData = JSON.parse(event.target.result);
            const features = geojsonData.features;
            log(`Ditemukan ${features.length} lokasi di dalam file.`);
            
            const batchSize = 400;
            let processed = 0;
            let skipped = 0;

            for (let i = 0; i < features.length; i += batchSize) {
                const batch = writeBatch(db);
                const chunk = features.slice(i, i + batchSize);
                
                progressDiv.textContent = `Memproses ${i + 1}-${Math.min(i + batchSize, features.length)} dari ${features.length}...`;
                
                for (const feature of chunk) {
                    try {
                        const props = feature.properties;
                        
                        // Validasi data minimal
                        if (!props.name || !feature.geometry || !feature.geometry.coordinates) {
                            log(`[${feature.id || 'unknown'}] Dilewati: Data tidak lengkap`);
                            skipped++;
                            continue;
                        }

                        const coords = feature.geometry.coordinates;
                        
                        // Data dasar dari OSM
                        const dataToSave = {
                            nama: props.name || 'Tidak Diketahui',
                            alamat: props['addr:street'] || props.address || '',
                            kota: props['addr:city'] || '',
                            provinsi: props['addr:province'] || props['addr:state'] || '',
                            lat: coords[1],
                            lon: coords[0],
                            deskripsi: props.description || '',
                            imageUrl: props['wikimedia_commons'] || '',
                            sumber: "OSM",
                            tipe: feature.geometry.type || 'node',
                            osm_id: feature.id || null,
                            timestamp: new Date().toISOString()
                        };

                        // Generate ID dokumen yang aman
                        const docId = `osm_${feature.id}`.replace(/\//g, '_').replace(/[^a-zA-Z0-9_-]/g, '');
                        
                        const docRef = doc(db, 'klenteng', docId);
                        batch.set(docRef, dataToSave);
                        processed++;
                        
                    } catch (error) {
                        log(`[${feature.id || 'unknown'}] Error: ${error.message}`);
                        skipped++;
                    }
                }

                try {
                    await batch.commit();
                    log(`Batch ${Math.floor(i / batchSize) + 1} selesai (${processed} data, ${skipped} dilewati).`);
                } catch (batchError) {
                    log(`Error commit batch: ${batchError.message}`);
                }
            }

            log(`SELESAI! ${processed} data berhasil diimpor, ${skipped} data dilewati.`);
            
        } catch (error) {
            log(`Error utama: ${error.message}`);
            console.error('Error detail:', error);
        } finally {
            importBtn.disabled = false;
            importBtn.textContent = 'Mulai Impor';
            progressDiv.textContent = '';
        }
    };
    reader.readAsText(file);
});
